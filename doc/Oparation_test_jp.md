# Operation test
こちらはHalfcliffの入力動作テスト用の資料です。(作成中)

ファームウェア書込み環境を構築し、ProMicroへファームウェアを書込み、キーボードの動作テストを行うまでの手順を記載しています。

本手順はWindows(厳密にはWindows10)にてQMK MSYSまたはQMK Toolboxを使用する場合を基準にしています。

キーボード組立中や、キーボード組立後の入力動作テストにご活用ください。

おおまなか手順は以下の通りです。
* (QMK MSYSを使用する場合)ファームウェア書込み環境の構築
* (QMK MSYSを使用する場合)ProMicroへのファームウェア書込み
* (QMK Toolboxを使用する場合)ファームウェア書込み環境の構築
* (QMK Toolboxを使用する場合)ProMicroへのファームウェア書込み
* 左右のキーボードのTRRSケーブルでの接続
* **左キーボード**のProMicroとPC間をUSBケーブルで接続
* 入力動作テスト

QMK MSYSとQMK Toolboxのどちらを使用するかは好みですが、

* 動作テスト時はQMK Toolboxを使用し、必要に応じてQMK MSYSに移行する

という流れをお勧めします。(詳しい方はその限りではありません。)

というのも、現状のHalfcliffの場合、QMK MSYS使用時の動作テストでは一部のキーの動作を確認しにくいためです。(例えばCtrlキー等)

QMK Toolbox使用時は、テスト専用のファイルを使用するので、動作テスト時に必ず何らかのキーが入力されるようになっています。
　
# (QMK MSYSを使用する場合)ファームウェア書込み環境の構築

ファームウェア書込み環境構築のため、QMK MSYSの公式のWeb ページ

https://msys.qmk.fm/

からQMK MSYSをダウンロードします。

ざっくりとした流れは以下の通りです。

Webページにアクセス→Latest Versionをクリック→最新版のQMK MSYSのバージョン確認→最新版のQMK_MSYS.exeをクリックしてダウンロード

ダウンロード後、PCのデスクトップ等に任意の名前のフォルダを1つ作成します。

(出来れば英語の、スペースを使用しないファイル名が良いです。github_workとか)

<img width="155" alt="フォルダ" src="https://user-images.githubusercontent.com/54104281/88303108-94214c80-cd41-11ea-957e-8696f901dc56.png">

フォルダ作成後、フォルダの上にマウスカーソルを移動して右クリックします。その後「プロパティ」をクリックします。

クリック後、表示されたダイアログにて、画像の赤枠で囲んだ部分(フォルダのパス。フォルダの場所を示すもの）をコピーしてメモ帳等に貼り付けておきます。

<img width="300" alt="フォルダのパス" src="https://user-images.githubusercontent.com/54104281/88304171-e3b44800-cd42-11ea-993a-4b857d0bba86.png">

その後、ダウンロードしたQMK MSYSをインストールします。

インストールの手順はこちらのWebページの、

* QMK Firmwareのダウンロードとインストール（本家を使う場合）

が非常に参考になります。(ページの作成者様にこの場を借りて感謝致します。)

https://gist.github.com/e3w2q/4bc86e531d1c893d3d13af3e9895a94a

上記のWebページの、

```
qmk setup --home C:/<path>/qmk_firmware
```

を入力する所まで進んだら、代わりに

```
qmk setup N2-sumikko/qmk_firmware --home コピーしたフォルダのパス/qmk_firmware
```

と入力してEnterキーを押します。ただし、ここではコピーしたフォルダのパスの「￥」または「\」は「/」に置き換えます。

例えば、

```
C:\Users\USER\Desktop\github_work
```

の場合は

```
C:/Users/USER/Desktop/github_work
```

に置き換えます。

qmk setupの実行中、何度か[y/n]の確認メッセージが出ますが、これらに対してはyを入力後Enterを押します。(セットアップにはしばらく時間がかかります。)

完了後、

```
cd コピーしたフォルダのパス/qmk_firmware
```

と入力し、Enterキーを押します。前の手順と同様、「￥」または「\」は「/」に置き換えます。

場合によっては、上のコマンドの実行前に

```
cd C:(コピーしたフォルダのパスがD:だったりE:だったりする場合は対応するものを入力)
```

等のコマンドの実行が必要な場合もあります。うまくいかない時は試してみてください。

コマンドを実行すると、先ほど作成したフォルダの中へ移動されます。

例えば、QMK MSYS起動後すぐにフォルダ

```
C:Users/USER/Desktop/github_work/qmk_firmware/
```

に移動する手順を実行した場合、以下のような画面になります。

![フォルダ移動後](https://user-images.githubusercontent.com/54104281/126988722-7d85002b-075e-4bf3-86c3-95ebb8160aa2.png)


フォルダへの移動が出来たら、ファームウェア書込み環境の構築は完了です。

#  (QMK MSYSを使用する場合)ProMicroへのファームウェア書込み

ファームウェア書き込みのために、左右いずれかのキーボードのProMicroとPC間をUSBケーブルで接続します。

ファームウェアは左右両方のProMicroへ書き込む必要があります。

USBケーブルは通信可能なものを使用します。

接続後、以下のコマンドを入力し、Enterキーを押します。(defaultの部分はviaに変えても良いです。）

```
qmk flash -kb halfcliff -km default
```

すると、ファームウェアの書込みが開始されます。(書込み開始まで少し時間がかかる場合があるので、しばらく待ちます。)

しばらすると「.」が 1つずつ増えていく状態になります。

その状態で、画像のようにピンセット等でProMicroの下にあるリセットスイッチを押します。(画像は組立後のキーボードですが、作業内容は同じです。)

![IMG_20210725_230624](https://user-images.githubusercontent.com/54104281/126964893-35e7dbbe-f2f3-4a33-acd2-2e9da88f1e64.jpg)


リセットスイッチを押すと画面の状態が変わり、処理が先に進みます。「Thank you.」と表示されたら、ファームウェアの書込みは完了です。

もう片方のキーボードに対しても同様の手順でファームウェアを書込みます。

# (QMK Toolboxを使用する場合)ファームウェア書込み環境の構築

QMK Toolboxを使用する場合、まずは以下のURL

https://github.com/qmk/qmk_toolbox/releases

にアクセスします。その後、最新版(2021/07/24時点では0.0.21)の「qmk_toolbox.exe」をクリックし、実行ファイルをダウンロードします。

ダウンロード後、PCのデスクトップ等に任意の名前のフォルダを1つ作成します。

(出来れば英語の、スペースを使用しないファイル名が良いです。QMK_Toolboxとか)

作成後、QMK Toolboxをダウンロードしたフォルダを開き、ダウンロードした「qmk_toolbox.exe」をフォルダ内に移動します。

(フォルダを作成して実行ファイルを移動する手順は必須ではありませんが、管理しやすくするために行うことをお勧めします。)

移動後、実行ファイルをダブルクリックなどで実行します。

実行後表示されるダイアログでは「はい」をクリックします。

![実行時に表示されるダイアログ](https://user-images.githubusercontent.com/54104281/126859435-16f8cb54-3407-43a9-8db7-4ec2766603b9.png)

クリック後に以下の画面が表示されるので、閉じるのを待ちます。

![ドライバインストール時ダイアログ](https://user-images.githubusercontent.com/54104281/126859557-cfc0cc68-f010-41db-af15-70bdf3a8b636.png)

その後、以下の画面が表示されたら、ファームウェア書き込み環境構築は完了です。

![QMK_Toolbox起動後](https://user-images.githubusercontent.com/54104281/126859604-6beb94f8-2b52-41cc-bf48-62ecc2ab85bb.png)

# (QMK Toolboxを使用する場合)ProMicroへのファームウェア書込み

ファームウェア書き込みのために、左右いずれかのキーボードのProMicroとPC間をUSBケーブルで接続します。

ファームウェアは左右両方のProMicroへ書き込む必要があります。

USBケーブルは通信可能なものを使用します。

接続後、以下のURLにアクセスし、ファームウェアの書き込みに必要な.hexファイルをダウンロードします。

https://github.com/N2-Sumikko/HalfCliff

ダウンロードは、URLにアクセス後、

Codeをクリック→Download ZIPをクリック

という手順で行います。

ダウンロードが完了したら、任意の場所にフォルダを展開(解凍)します。

解凍後、QMK Toolboxにてopenをクリックし、

展開したフォルダ「HalfCliff-master」内の

```
hex/test
```

にある「halfcliff_test.hex」ファイルを選択します。

![hex選択後](https://user-images.githubusercontent.com/54104281/126997225-7fa0c591-671d-41dd-b679-cb1b61a27e46.png)

その後、画面の右上の方にあるAuto-Flashのチェックボックスをクリックしチェックを入れます。

![Auto-Flashチェック後](https://user-images.githubusercontent.com/54104281/126997247-fa9ecaa4-cac1-4346-ab89-943dad6a06f4.png)

念のため、右上のMCUの項目がatmega32u4であることも確認しておきます。

その状態で、画像のようにピンセット等でProMicroの下にあるリセットスイッチを押します。(画像は組立後のキーボードですが、作業内容は同じです。)

![IMG_20210725_230624](https://user-images.githubusercontent.com/54104281/126964893-35e7dbbe-f2f3-4a33-acd2-2e9da88f1e64.jpg)

すると、ProMicroへのファームウェアの書込みが自動で開始されます。

最終的に以下のような画面が表示されれば書込み完了です。

![書込み完了後](https://user-images.githubusercontent.com/54104281/126997352-f790fd9f-725e-4915-a5ef-b513f144d13a.png)

もう片方のキーボードも同様の手順でファームウェアを書き込みます。

# 左右のキーボードのTRRSケーブルでの接続

左右のキーボードのTRRSジャック間をTRRSケーブルで接続します。TRRSケーブルは画像のように奥まで差し込んでください。

(TRRSケーブルを奥まで差し込んだ画像)

# **左キーボード**のProMicroとPC間をUSBケーブルで接続

**左キーボード**のProMicroとPC間をUSBケーブルで接続します。**左キーボード**ですので注意して下さい。

halfcliffは通常の設定では、左キーボードのProMicroにUSBケーブルを接続しないと正しく動作しません。

# 入力動作テスト

左右のキーボード間をTRRSケーブル、左キーボードとPC間をUSBケーブルで接続した状態で以下のURLをクリックし、キーボードテスター様のサイトを表示します。

https://www.keyboardtester.com/tester.html

その後、画像のようにピンセット等で、基板のキースイッチ用のランド(キースイッチの端子をはんだ付けする場所)間をショートさせます。

(ピンセットの代わりに、押した状態のキースイッチを使うのも良いかと思います。スイッチがはんだ付け済みの場合はスイッチを押します。)

![入力動作確認用](https://user-images.githubusercontent.com/54104281/88373551-ffffc580-cdd2-11ea-85f6-d4032195b3a9.png)

組立が正しく行われていれば、ショートさせた箇所に対応するキーが入力されます。

これを左右基板の各端子、もしくはキースイッチに対して行います。

キーマップ通りにキーが入力されることを確認したら、入力動作テストは完了です。

問題がある場合は、

*   はんだ付けが行われていない場所が無いか

*   はんだが不十分な場所は無いか

*   本来繋がらない筈の箇所がはんだで繋がっていないか

*   使用している部品に問題は無いか

*   ダイオード等の部品の向きは正しいか

等を確認します。異常がある場所を見つけたら1つずつ修正していき、改めて動作を確認します。
