# Operation test
こちらはHalfcliffの入力動作テスト用の資料です。(作成中)

ファームウェア書込み環境を構築し、ProMicroへファームウェアを書き込み、キーボードの入力動作を確認するまでの手順を記載しています。

本手順はWindows(厳密にはWindows10)にてキャラクタユーザインターフェース用のソフトウェアであるQMK MSYSを使用する場合を基準にしています。

キーボード組立中や、キーボード組立後の入力動作テストにご活用ください。

おおまなか手順は以下の通りです。
* (QMK MSYSを使用する場合)ファームウェア書込み環境の構築
* (QMK MSYSを使用する場合)ProMicroとPC間の接続
* (QMK MSYSを使用する場合)ProMicroへのファームウェア書込み
* (QMK Toolboxを使用する場合)ファームウェア書込み環境の構築
* (QMK Toolboxを使用する場合)ProMicroとPC間の接続
* (QMK Toolboxを使用する場合)ProMicroへのファームウェア書込み
* 左右のキーボードのTRRSケーブルでの接続
* **左キーボード**のProMicroとPC間をUSBケーブルで接続
* 入力動作テスト



# (QMK MSYSを使用する場合)ファームウェア書込み環境の構築

ファームウェア書込み環境構築のため、こちらのWeb ページ

https://msys.qmk.fm/

を参考に、QMK MSYSをダウンロードします。

ダウンロード後、PCのデスクトップ等に任意の名前のフォルダを1つ作成します。

(出来れば英語の、スペースを使用しないファイル名が良いです。(github_workとか)

<img width="155" alt="フォルダ" src="https://user-images.githubusercontent.com/54104281/88303108-94214c80-cd41-11ea-957e-8696f901dc56.png">

フォルダ作成後、フォルダの上にマウスカーソルを移動して右クリックします。その後「プロパティ」をクリックします。

クリック後、表示されたダイアログにて、画像の赤枠で囲んだ部分(フォルダのパス。フォルダの場所を示すもの）をコピーしてメモ帳等に貼り付けておきます。

<img width="300" alt="フォルダのパス" src="https://user-images.githubusercontent.com/54104281/88304171-e3b44800-cd42-11ea-993a-4b857d0bba86.png">

ダウンロード後、QMK MSYSをインストールします。

インストールの手順はこちらのWebページの、

「QMK Firmwareのダウンロードとインストール（フォークされたQMKを使う場合）」

が非常に参考になります。(ページの作成者様にこの場を借りて感謝致します。)

https://gist.github.com/e3w2q/4bc86e531d1c893d3d13af3e9895a94a

halfcliffの場合、

```
qmk setup --home C:/<path>/qmk_firmware
```

を入力する所まで進んだら、

```
qmk setup N2-sumikko/qmk_firmware --branch add_halfcliff --home コピーしたフォルダのパス/qmk_firmware
```

と入力してEnterキーを押します。ただし、ここではコピーしたフォルダのパスの「￥」または「\」は「/」に置き換えます。

例えば、

```
C:\Users\USER\Desktop\github_work
```

は

```
C:/Users/USER/Desktop/github_work
```

に置き換えます。

qmkのsetupの実行中、何度か[y/n]の確認メッセージが出ますが、これらに対してはyを入力後Enterを押します。

その後、

```
cd コピーしたフォルダのパス/qmk_firmware
```

と入力し、Enterキーを押します。

場合によっては、このコマンドの実行前に

```
cd C:(コピーしたフォルダのパスがD:だったりE:だったりする場合は対応するものを入力)
```

等のコマンドの実行が必要な場合もあります。

コマンドを実行すると、先ほど作成したフォルダの中へ移動されます。

移動後、以下のコマンドを入力し、Enterキーを押します。


その後、以下のコマンドを入力し、Enterキーを押します。



すると、ファームウェア書込みを行うフォルダの中へ移動されます。以上でファームウェア書込み環境の構築は完了です。

# (QMK MSYSを使用する場合)ProMicroとPC間の接続

ProMicro基板とキースイッチ基板の接続まで完了したキーボードのProMicroとPC間をUSBケーブルで接続します。

USBケーブルには充電のみ可能なものと、通信可能なものがあります。通信可能なものを使用するので、間違えないように注意してください。

#  (QMK MSYSを使用する場合)ProMicroへのファームウェア書込み

接続後、以下のコマンドを入力し、Enterキーを押します。(defaultの部分はviaに変えても良いです。）

```
qmk flash -kb halfcliff -km default
```

すると、ファームウェアの書込みが開始されます。(書込み開始まで少し時間がかかる場合があるので、しばらく待ちます。)

しばらすると「.」が 1つずつ増えていく状態になります。

(待ち状態の画像)

その状態で、画像のようにピンセット等でリセットスイッチを押します。(画像は説明のため、USBケーブルを取外しています。)

(リセットスイッチを押している画像) 

リセットスイッチを押すと画面の状態が変わり、処理が先に進みます。画像のように「Thank you.」が表示されたら、ファームウェアの書込みは完了です。

(ファームウェア)書き込み完了後の画像

もう片方のキーボードに対しても同様の手順でファームウェアを書き込みます。

# 左右のキーボードのTRRSケーブルでの接続

左右のキーボードのTRRSジャック間をTRRSケーブルで接続します。TRRSケーブルは画像のように奥まで差し込んでください。

(TRRSケーブルを奥まで差し込んだ画像)

# **左キーボード**のProMicroとPC間をUSBケーブルで接続

**左キーボード**のProMicroとPC間をUSBケーブルで接続します。**左キーボード**ですので注意して下さい。

halfcliffは通常の設定では、左キーボードのProMicroにUSBケーブルを接続しないと正しく動作しません。

# 入力動作テスト

左右のキーボード間をTRRSケーブル、左キーボードとPC間をUSBケーブルで接続した状態で以下のURLをクリックし、キーボードテスター様のサイトを表示します。

https://www.keyboardtester.com/tester.html

その後、画像のようにピンセット等で、基板のキースイッチ用のランド(キースイッチの端子をはんだ付けする場所)間をショートさせます。

(ピンセットの代わりに、押した状態のキースイッチを使うのも良いかと思います。スイッチがはんだ付け済みの場合はスイッチを押します。)

![入力動作確認用](https://user-images.githubusercontent.com/54104281/88373551-ffffc580-cdd2-11ea-85f6-d4032195b3a9.png)
(ピンセット等で端子を導通させている画像)

組立が正しく行われていれば、ショートさせた箇所に対応するキーが入力されます。

QMK MSYSを使用して動作テストを行う場合、例えばshiftキー等は入力したかどうかわかりにくいかと思います。(要対応)
QMK MSYSを使用する場合は、まずはコンパイルして、そのあとにhexファイルを動作確認用に置き換えるか？


これを左右基板の各端子、もしくはキースイッチに対して行います。

キーマップ通りにキーが入力されることを確認したら、入力動作テストは完了です。

問題がある場合は、

*   はんだ付けが行われていない場所が無いか

*   はんだが不十分な場所は無いか

*   本来繋がらない筈の箇所がはんだで繋がっていないか

*   使用している部品に問題は無いか

*   ダイオード等の部品の向きは正しいか

等を確認します。異常がある場所を見つけたら1つずつ修正していき、改めて動作を確認します。
